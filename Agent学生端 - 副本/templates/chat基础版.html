<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentèŠå¤©æœºå™¨äººå¯¹è¯ç•Œé¢</title>
    <style>
      /* åŸºç¡€å¸ƒå±€ - å‚è€ƒç½‘é¡µ6 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #f0f2f5;
        height: 100vh;
        display: flex;
      }

      /* ä¾§è¾¹æ  - å‚è€ƒç½‘é¡µ5 */
      .sidebar {
        width: 280px;
        background:whitesmoke;
        border-right: 1px solid #e0e0e0;
        padding: 20px;
        overflow-y: auto;
      }

      /* ä¸»å¯¹è¯çª—å£ - å‚è€ƒç½‘é¡µ7 */
      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      /* æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ - å‚è€ƒç½‘é¡µ4 */
      .message-area {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: white;
      }

      /* æ¶ˆæ¯æ°”æ³¡ - å‚è€ƒç½‘é¡µ4å’Œç½‘é¡µ7 */
      .message {
        max-width: 70%;
        margin: 12px 0;
        display: flex;
        gap: 12px;
      }

      .user-message {
        flex-direction: row-reverse;
        margin-left: auto;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e0e0e0;
      }

      .bubble {
        padding: 12px 16px;
        border-radius: 12px;
        line-height: 1.5;
        max-width: 600px;
      }

      .assistant-bubble {
        background: #fff;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .user-bubble {
        background: #1890ff;
        color: white;
      }

      /* è¾“å…¥åŒºåŸŸ - å‚è€ƒç½‘é¡µ1å’Œç½‘é¡µ8 */
      .input-area {
        padding: 20px;
        background: #fff;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 12px;
      }

      textarea {
        flex: 1;
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        resize: none;
        font-size: 16px;
        line-height: 1.5;
      }

      button {
        padding: 12px 24px;
        background: #1890ff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
      }

      button:hover {
        background: #096dd9;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <!-- å¯¹è¯åˆ—è¡¨ -->
      <h2>æ¬¢è¿ä½ ï¼{{ username }}</h2>
      <div class="conversation-list">
        {% for session in sessions %}
        <div class="conversation-item{% if session.status == "active" %}{% endif %}">
          {{ session.summary | truncatechars:20 }}
        </div>
        {% endfor %}
      </div>
    </div>

  <div class="chat-container">
        <div class="message-area" id="messageContainer">
            <!-- ç¤ºä¾‹æ¶ˆæ¯ -->
            <div class="message">
                <div class="avatar"></div>
                <div class="bubble assistant-bubble">
                    æ‚¨å¥½ï¼æˆ‘æ˜¯Agentè€çˆµçˆ·ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ
                </div>
            </div>
        </div>
        
        <div class="input-area">
            <textarea 
                id="messageInput" 
                placeholder="è¾“å…¥æ¶ˆæ¯..." 
                rows="1"
                oninput="autoResize(this)"
            ></textarea>
            <button onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        // è‡ªé€‚åº”è¾“å…¥æ¡†é«˜åº¦
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }
        function getCookie(name) {
          let cookieValue = null;
          document.cookie.split(';').forEach(c => {
            const [k,v] = c.trim().split('=');
            if (k === name) cookieValue = decodeURIComponent(v);
          });
          return cookieValue;   
        }
        // å‘é€æ¶ˆæ¯åŠŸèƒ½ - å‚è€ƒç½‘é¡µ1å’Œç½‘é¡µ8
        function sendMessage() {
            const csrftoken = getCookie('csrftoken');
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            const btn = document.querySelector('.input-area button');
            btn.disabled = true;
            btn.textContent = 'å‘é€ä¸­...';

            // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.innerHTML = `
                <div class="avatar" style="background:#1890ff"></div>
                <div class="bubble user-bubble">${message}</div>
            `;
            fetch('chat/',{
                method:'POST',
                headers:{
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,  
                },
                credentials: 'include',  
                body:JSON.stringify({message:message})
            })
            .then(response=>{
                if(!response.ok)throw new Error('ç½‘ç»œå“åº”å¼‚å¸¸');
                return response.json();
            })
            .then(data=>{
                if(data.status==='success'){
                    const assistantBubbles = document.querySelectorAll('.assistant-bubble');
                    const lastBubble = assistantBubbles[assistantBubbles.length-1];
                    lastBubble.textContent = data.bot_response
                }else{
                    console.error('åç«¯é”™è¯¯',data.message);
                }
            })

            .catch(error => {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                // ğŸ”¥ å¯é€‰ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º
                alert('æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'å‘é€';
            });
            // åˆ›å»ºåŠ©æ‰‹å›å¤
            const assistantReply = document.createElement('div');
            assistantReply.className = 'message';
            assistantReply.innerHTML = `
                <div class="avatar"></div>
                <div class="bubble assistant-bubble">
                    å·²æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼š"${message}"ã€‚æˆ‘æ­£åœ¨æ€è€ƒå¦‚ä½•å›ç­”...{{ user_input }}
                </div>
            `;

            // æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨
            const container = document.getElementById('messageContainer');
            container.appendChild(userMessage);
            container.appendChild(assistantReply);
            
            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®é«˜åº¦
            input.value = '';
            autoResize(input);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ - å‚è€ƒç½‘é¡µ1
            container.scrollTop = container.scrollHeight;
        }

        // å›è½¦å‘é€åŠŸèƒ½ - å‚è€ƒç½‘é¡µ1
        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>